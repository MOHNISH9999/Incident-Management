sap.ui.define([
	"sap/ui/core/mvc/Controller",
	"sap/ui/model/json/JSONModel",
	"sap/m/Dialog",
	"sap/m/Image",
	"sap/m/Button"
], function (Controller, JSONModel, Dialog, Image, Button) {
	"use strict";
	return Controller.extend("com.crave.Incident_Management.controller.Incident_Detail", {
		formatter: {
			formatDateTime: function (dateTime) {
				// Assuming dateTime is in ISO format (e.g., "2023-06-11T10:30:00Z")
				let oDate = new Date(dateTime);
				let options = {
					year: "numeric",
					month: "long",
					day: "numeric"
				};
				return oDate.toLocaleString(undefined, options);
			}
		},
		onInit: function () {
			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
			oRouter.getRoute("Incident_Detail").attachPatternMatched(this._onObjectMatched, this);
		},
		_onObjectMatched: function (oEvent) {
			this.sUsername = oEvent.getParameter("arguments").username;
			var sUsername = oEvent.getParameter("arguments").username;
			var sIncidentPath = decodeURIComponent(oEvent.getParameter("arguments").incidentPath);
			this._loadIncidentData(sIncidentPath, sUsername);
		},
		_loadIncidentData: function (sIncidentPath, sUsername) {
			var oIncidentModel = this.getView().getModel("incidentDataModel");
			this.getView().bindElement({
				path: sIncidentPath,
				model: "incidentDataModel"
			});
			this._loadUserData(sUsername);
		},
		onImagePress: function (oEvent) {
			var sImageSrc = oEvent.getSource().getSrc();
			if (!this._oImageDialog) {
				this._oImageDialog = new Dialog({
					title: "Preview",
					contentWidth: "90%",
					contentHeight: "40%",
					content: new Image({
						src: sImageSrc,
						width: "100%",
						height: "100%"
					}),
					endButton: new Button({
						text: "Close",
						press: function () {
							this._oImageDialog.close();
						}.bind(this)
					})
				});
				this.getView().addDependent(this._oImageDialog);
			} else {
				this._oImageDialog.getContent()[0].setSrc(sImageSrc);
			}
			this._oImageDialog.open();
		},
		_loadUserData: function (sUsername) {
			if (sUsername) {
				var oUserModel = this.getOwnerComponent().getModel("userDataModel");
				if (!oUserModel) {
					oUserModel = new JSONModel();
					oUserModel.loadData("./model/user.json", null, false);
					this.getOwnerComponent().setModel(oUserModel, "userDataModel");
				}
				var aUsers = oUserModel.getData();
				var oUserDetails = aUsers.find(function (user) {
					return user.username === sUsername;
				});
				if (oUserDetails) {
					var oUserDetailModel = new JSONModel(oUserDetails);
					this.getView().setModel(oUserDetailModel, "userDetailModel");
				} else {
					console.error("User details not found for username:", sUsername);
				}
			} else {
				console.error("Username not provided");
			}
		},
		onBackPress: function (oEvent) {
			var oHistory = sap.ui.core.routing.History.getInstance();
			var sPreviousHash = oHistory.getPreviousHash();
			if (sPreviousHash !== undefined) {
				window.history.go(-1);
			} else {
				var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
				oRouter.navTo("masterView", {}, true);
			}
		},
		onUpdatePress: function (oEvent) {
			var oItem = oEvent.getSource();
			var oBindingContext = oItem.getBindingContext("incidentDataModel");
			var sPath = oBindingContext.getPath();
			var sUsername = oBindingContext.getProperty("username");
			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
			oRouter.navTo("Update_Detail", {
				username: sUsername,
				incidentPath: encodeURIComponent(sPath)
			});
		},
		/**
		 *@memberOf com.crave.Incident_Management.controller.Incident_Detail
		 */
		onBack: function (oEvent) {
			//This code was generated by the layout editor.
			
			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
			oRouter.navTo("Incident_List", {
				username: this.sUsername
			});
		}
	});
});